@(feed: Call, message: Call)(implicit requestHeader: RequestHeader)

@main("Chat") {
    <div class="chat">
        <div class="messages">
            <div class="no-messages">
                No messages yet
            </div>
        </div>
        <hr>
        <form class="form-horizontal">
            <div class="form-group">
                <label for="input-user" class="col-sm-2 control-label">
                    Nick
                </label>
                <div class="col-sm-10">
                    <input id="input-user" type="text" class="form-control" placeholder="Type nick here..." value="@{"User" + scala.util.Random.nextInt(100)}">
                </div>
            </div>
            <div class="form-group">
                <label for="input-content" class="col-sm-2 control-label">
                    Message
                </label>
                <div class="col-sm-10">
                    <textarea id="input-content" class="form-control" placeholder="Type message here..." rows="5"></textarea>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <button type="submit" class="form-control btn btn-primary">Submit</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        $(function () {
            var $chat = $('.chat');
            var $messages = $chat.find('.messages');
            var $noMessages = $messages.find('.no-messages');
            var $form = $chat.find('form');
            var $inputUser = $form.find('#input-user');
            var $inputContent = $form.find('#input-content');

            var submitMessage = function (user, content) {
                if (user === '') {
                    alert('Nick cannot be empty!');
                    return;
                } else if (content === '') {
                    alert('Message cannot be empty!');
                    return;
                }

                $.ajax({
                    method: 'post',
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    url: '@message.absoluteURL()',
                    data: JSON.stringify({
                        user: user,
                        content: content
                    })
                });
            };

            var escapeString = function (string) {
                return $('<span />').text(string).html();
            };

            $form.on('submit', function (e) {
                var user = $inputUser.val();
                var content = $inputContent.val();

                submitMessage(user, content);

                $inputContent.val('');
                e.preventDefault();
                return false;
            });

            $inputContent.on('keydown', function (e) {
                if (e.keyCode == 13 && !e.shiftKey) {
                    $form.submit();
                    return false;
                }
            });

            var feed = new EventSource('@feed.absoluteURL()');
            feed.addEventListener('message', function (response) {
                $noMessages.remove();
                var message = JSON.parse(response.data);
                var $message = $('<div class="message row" />')
                    .append('<div class="col-sm-2"><div class="user">' + escapeString(message.user) + '</div></div>')
                    .append('<div class="col-sm-10"><div class="content">' + escapeString(message.content) + '</div></div>');

                $message.appendTo($messages);
                $messages.animate({ scrollTop: $(document).height() }, "slow");
            });

            $inputContent.focus();
        });
    </script>
}
